executor: workspace-setup
input:
  name: ''
  directory: ''
  provider: ''
  region: ''
  email: ''
  project: ''

  # Azure variables
  azureSubscriptionId: ''
  azureTenantId: ''
  azureStorageAccount: ''
steps:
  - script: |
      cat << EOF > {{ .input.directory }}/workspace.yaml
      apiVersion: plural.sh/v1alpha1
      kind: ProjectManifest
      metadata:
        name: {{ .input.name }}
      spec:
        cluster: {{ .input.name }}
        bucket: {{ .input.project }}-tf-state
        project: {{ .input.project }}
        provider: {{ .input.provider }}
        region: {{ .input.region }}
        owner:
          email: {{ .input.email }}
        network:
          subdomain: {{ .input.name }}.onplural.sh
          pluraldns: true
        availabilityzones: []
        bucketPrefix: {{ .input.project }}
        context:
          StorageAccount: {{ .input.azureStorageAccount }}
          SubscriptionId: {{ .input.azureSubscriptionId }}
          TenantId: {{ .input.azureTenantId }}
    assertions:
      - result.code ShouldEqual 0
