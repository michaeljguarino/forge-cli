name: Plural up
description: TODO

vars:
  ### Core variables
  # Branch that will be created to run 'plural up'
  branch: ''
  # Local directory used to set up git repository (clone, checkout)
  directory: ''
  # Plural user email to run 'plural up' with
  email: ''
  # Git repository address used to run 'plural up' and store generated files
  gitRepo: ''
  # SSH key path used to access git repository
  gitRepoPrivateKeyPath: ''
  # Plural user name
  username: ''
  # Plural user acess token
  token: ''
  # Local plural home directory used to store plural files
  pluralHome: ''
  # Provider-specific project name/id
  project: ''
  # Provider name: gcp, azure, aws
  provider: ''
  # Provider region used to spin up the cluster
  region: ''
  # Plural aes key used to encrypt/decrypt git repository files
  pluralKey: ''

  # Azure variables
  azureSubscriptionId: ''
  azureTenantId: ''
  azureStorageAccount: ''

  ### GCP variables
  # Google Service Account email
  gcpEmail: ''
  # Google Service Account key file
  gcpSAKeyFile: ''
  # Google organization ID
  gcpOrgID: ''
  # Google billing account ID
  gcpBillingID: ''

secrets:
  - pluralKey
  - token
  - gcpSAKeyFile
  - gcpOrgID
  - gcpBillingID
  - azureSubscriptionId
  - azureTenantId
  - azureStorageAccount

testcases:
  - name: Check required arguments
    steps:
      - type: check-required
        assertions:
          - result.code ShouldEqual 0

  - name: Setup Git
    steps:
      - type: git-setup
        assertions:
          - result.code ShouldEqual 0

  - name: Setup workspace file
    steps:
      - type: workspace-setup
        name: {{ .username }}
        directory: {{ .directory }}
        provider: {{ .provider }}
        region: {{ .region }}
        email: {{ .email }}
        project: {{ .project }}
        azureSubscriptionId: {{ .azureSubscriptionId }}
        azureTenantId: {{ .azureTenantId }}
        azureStorageAccount: {{ .azureStorageAccount }}
        assertions:
          - result.code ShouldEqual 0


  - name: Setup context file
    steps:
      - type: context-setup
        assertions:
          - result.code ShouldEqual 0

  - name: Plural login
    steps:
      - type: plural-login
        email: {{ .email }}
        name: {{ .username }}
        pluralHome: {{ .pluralHome }}
        token: {{ .token }}
        key: {{ .pluralKey }}
        assertions:
          - result.code ShouldEqual 0

  - name: Google Cloud Setup
    skip:
      - provider ShouldEqual gcp
    steps:
      - type: gcloud-setup
        email: {{ .gcpEmail }}
        saKeyFile: {{ .gcpSAKeyFile }}
        orgID: {{ .gcpOrgID }}
        billingID: {{ .gcpBillingID }}
        project: {{ .project }}
        assertions:
          - result.code ShouldEqual 0

  - name: Plural up
    steps:
      - script: |
          cd {{ .directory }} ;\
          plural up --commit "Plural up e2e cluster"
        retry: 3
        delay: 5

  - name: Azure teardown
    skip:
      - provider ShouldEqual azure
    steps:
      - type: azure-teardown
        resourceGroup: {{ .project }}
        retry: 3
        retry_if:
          - result.code ShouldNotEqual 0
        delay: 5

  - name: Google Cloud teardown
    skip:
      - provider ShouldEqual gcp
    steps:
      - type: gcloud-teardown
        email: {{ .gcpEmail }}
        saKeyFile: {{ .gcpSAKeyFile }}
        project: {{ .project }}
        retry: 3
        retry_if:
          - result.code ShouldNotEqual 0
        delay: 5

  - name: Git teardown
    steps:
        - type: git-teardown
          branch: {{ .branch }}
          directory: {{ .directory }}
          retry: 3
          retry_if:
            - result.code ShouldNotEqual 0
          delay: 5
