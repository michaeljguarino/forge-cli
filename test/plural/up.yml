name: Plural up
description: TODO

vars:
  # Core variables
  branch: ''
  directory: ''
  email: ''
  gitRepo: ''
  privateKeyPath: ''
  username: ''
  token: ''
  pluralHome: ''
  gitRepoPrivateKey: ''
  project: ''
  provider: ''
  region: ''
  pluralKey: ''

  # Azure variables
  azureSubscriptionId: ''
  azureTenantId: ''
  azureStorageAccount: ''

  # GCP variables
  gcpEmail: ''
  gcpSAKeyFile: ''
  gcpOrgID: ''
  gcpBillingID: ''

secrets:
  - pluralKey
  - token
  - gitRepoPrivateKey
  - gcpSAKeyFile
  - gcpOrgID
  - gcpBillingID
  - azureSubscriptionId
  - azureTenantId
  - azureStorageAccount

testcases:
  - name: Check required arguments
    steps:
      - type: check-required

  - name: Setup Git
    steps:
      - type: git-setup
        branch: {{ .branch }}
        directory: {{ .directory }}
        email: {{ .email }}
        gitRepo: {{ .gitRepo }}
        privateKeyPath: {{ .privateKeyPath }}
        username: {{ .username }}

  - name: Setup workspace file
    steps:
      - type: workspace-setup
        name: {{ .username }}
        directory: {{ .directory }}
        provider: {{ .provider }}
        region: {{ .region }}
        email: {{ .email }}
        project: {{ .project }}
        azureSubscriptionId: {{ .azureSubscriptionId }}
        azureTenantId: {{ .azureTenantId }}
        azureStorageAccount: {{ .azureStorageAccount }}

  - name: Setup context file
    steps:
      - type: context-setup
        directory: {{ .directory }}
        gitRepo: {{ .gitRepo }}
        gitRepoPrivateKey: {{ .gitRepoPrivateKey }}

  - name: Plural login
    steps:
      - type: plural-login
        email: {{ .email }}
        name: {{ .username }}
        pluralHome: {{ .pluralHome }}
        token: {{ .token }}
        key: {{ .pluralKey }}

  - name: Google Cloud Setup
    skip:
      - {{.provider}} NotEqual gcp
    steps:
      - type: gcloud-setup
        email: {{ .gcpEmail }}
        saKeyFile: {{ .gcpSAKeyFile }}
        orgID: {{ .gcpOrgID }}
        billingID: {{ .gcpBillingID }}
        project: {{ .project }}

  - name: Plural up
    steps:
      - script: |
          cd {{ .directory }} ;\
          plural up

  - name: Azure teardown
    skip:
      - {{ .provider }} NotEqual azure
    steps:
      - type: azure-teardown
        resourceGroup: {{ .project }}

  - name: Google Cloud teardown
    skip:
      - {{.provider}} NotEqual gcp
    steps:
      - type: gcloud-teardown
        email: {{ .gcpEmail }}
        saKeyFile: {{ .gcpSAKeyFile }}
        project: {{ .project }}

  - name: Git teardown
    steps:
        - type: git-teardown
          branch: {{ .branch }}
